{
  "$schema": "../schemas/tool-config.schema.json",

  "id": "perplexity",
  "name": "Perplexity",
  "vendor": "Perplexity AI",
  "vendor_url": "https://perplexity.ai",
  "category": "search",

  "source_type": "website",

  "domains": [
    "perplexity.ai",
    "www.perplexity.ai"
  ],

  "meta": {
    "docs_url": "https://www.perplexity.ai/hub"
  },

  "features": {
    "search": {
      "type": "chat",
      "name": "AI Search",
      "description": "AI-powered search with citations. Uses SSE with JSON diff/patch format for streaming.",

      "endpoints": [
        {
          "role": "both",
          "match": {
            "url": "**/rest/sse/perplexity_ask",
            "method": "POST"
          },
          "pipeline": [
            { "op": "parse", "format": "json", "apply_to": "request" },
            {
              "op": "stream",
              "transport": "sse",
              "apply_to": "response",
              "options": {
                "prefixes": ["data: "]
              }
            },
            {
              "op": "accumulate",
              "apply_to": "response",
              "rules": [
                { "when": "$exists(uuid)", "set": { "uuid": "uuid" } },
                { "when": "$exists(context_uuid)", "set": { "context_uuid": "context_uuid" } },
                { "when": "$exists(display_model)", "set": { "model": "display_model" } },
                { "when": "$exists(mode)", "set": { "mode": "mode" } },
                { "when": "$exists(thread_url_slug)", "set": { "thread_slug": "thread_url_slug" } },
                {
                  "when": "$exists(blocks) and blocks[intended_usage='ask_text_0_markdown'].diff_block.patches[op='replace'].value.chunks",
                  "set": { "content": "$join(blocks[intended_usage='ask_text_0_markdown'].diff_block.patches[op='replace'].value.chunks, '')" }
                },
                {
                  "when": "$exists(blocks) and blocks[intended_usage='ask_text_0_markdown'].diff_block.patches[op='add'].value and $type(blocks[intended_usage='ask_text_0_markdown'].diff_block.patches[op='add'].value) = 'string'",
                  "set": { "content": "blocks[intended_usage='ask_text_0_markdown'].diff_block.patches[op='add'].value" }
                },
                {
                  "when": "final_sse_message = true and $exists(blocks) and blocks[intended_usage='ask_text_0_markdown'].markdown_block.answer",
                  "set": { "answer": "blocks[intended_usage='ask_text_0_markdown'].markdown_block.answer" }
                }
              ],
              "fields": {
                "content": { "from": "content", "method": "concat" },
                "answer": { "from": "answer", "method": "last" },
                "uuid": { "from": "uuid", "method": "first" },
                "context_uuid": { "from": "context_uuid", "method": "first" },
                "model": { "from": "model", "method": "first" },
                "mode": { "from": "mode", "method": "last" },
                "thread_slug": { "from": "thread_slug", "method": "first" }
              }
            }
          ],
          "extract": {
            "request.prompt": "query_str",
            "request.message_id": "params.frontend_uuid",
            "request.thread_id": "params.frontend_context_uuid",
            "request.model": "params.model_preference",
            "request.mode": "params.mode",
            "request.search_focus": "params.search_focus",
            "response.content": "$accumulated.answer ? $accumulated.answer : $accumulated.content",
            "response.message_id": "$accumulated.uuid",
            "response.thread_id": "$accumulated.context_uuid",
            "response.model": "$accumulated.model",
            "response.mode": "$accumulated.mode",
            "response.thread_slug": "$accumulated.thread_slug"
          }
        }
      ],

      "output": {
        "mode": "extract",
        "tag": "ai:search",
        "normalize": {
          "interaction.type": "'search'",
          "interaction.input.text": "$request.prompt",
          "interaction.input.message_id": "$request.message_id",
          "interaction.output.text": "$response.content",
          "interaction.output.message_id": "$response.message_id",
          "interaction.thread_id": "$response.thread_id",
          "interaction.model": "$response.model",
          "interaction.mode": "$response.mode",
          "interaction.search_focus": "$request.search_focus"
        },
        "include_raw": false
      }
    }
  },

  "detection": [
    {
      "id": "user_settings",
      "match": { "url": "**/rest/user/settings", "method": "GET" },
      "pipeline": [
        { "op": "parse", "format": "json" }
      ],
      "extract": {
        "limits.pages": "pages_limit",
        "limits.uploads": "upload_limit",
        "limits.create": "create_limit",
        "limits.max_files": "max_files_per_user",
        "limits.max_file_size_mb": "connector_limits.max_file_size_mb",
        "limits.daily_attachments": "connector_limits.daily_attachment_limit"
      }
    }
  ],

  "pricing": {
    "model": ["free", "subscription"],
    "tiers": [
      { "id": "free", "name": "Free", "type": "free", "monthly_usd": 0 },
      { "id": "pro", "name": "Pro", "type": "individual", "monthly_usd": 20 },
      { "id": "enterprise", "name": "Enterprise", "type": "enterprise", "monthly_usd": null }
    ]
  }
}
